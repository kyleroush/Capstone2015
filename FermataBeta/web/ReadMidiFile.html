<!DOCTYPE html>
<html>
<head>
	<!-- External Scripts -->
	<script src="vexflow-debug.js"></script>
	<script src="vexflow-min.js"></script>
	<script src="JZZ.Midi.js"></script>
	<script src="JZZ.MidiFile.js"></script>
	<script src="http://code.jquery.com/jquery-2.1.0.min.js"></script>
	<style type="text/css">
	button {
		width:6em;
	}
	#midi {
		font-family:Courier New, monospace;
		background-color:#eef;
		border:none;
		padding:0.2em;
	}
	#midi div {
		border:double;
		margin:0.2em;
	}
	#midi div div {
		border:none;
	}
	#midi div div.hdr {
		font-weight:bold;
		border:none;
	}
	#midi span.clk {
		width:6em;
		padding:0 0.5em;
		text-align:right;
		display:inline-block;
		background-color:#ddd;
	}
	#midi .wait {
		padding:.2em;
		font-size:1.5em;
		font-weight:bold;
		color:#888;
	}
	#midi .err {
		padding:.5em;
		font-size:1.2em;
		font-weight:bold;
		color:#d00;
	}
	canvas {
		background: #eed;
		padding: 10px;
		border: 10px solid #ddc;
	}
	div.egcode {
		font-family: Courier;
		font-size: 14px;
	}
	</style>
</head>

<body>
<!-- Formatting Constants -->
<script>
	var STAFF_COUNT = 25
	var CANVAS_WIDTH = 700
	var CANVAS_HEIGHT = 120 * (STAFF_COUNT+1) + 20
	var STAFF_OFFSET_X = 10
	var STAFF_OFFSET_Y = 140
	var STAFF_OFFSET_Y_CENTER = (CANVAS_HEIGHT - 120) / 2
</script>

<!-- Necessary, Hidden Divisions -->
<div style="display: none;" id=fname>&nbsp;</div>
<div style="display: none;" id=midi>Files accepted: SMF (*.mid, *.kar), RMID (*.rmi)</div>

<!-- Create canvas -->
<script>
	document.write('<p><canvas width=' + (CANVAS_WIDTH+25) + ' height=' + CANVAS_HEIGHT + '></canvas></p>')
</script>

<!-- ReadMidiFile -->
<script>
function err(e)	{/*document.getElementById('midi').innerHTML='<span class=err>'+e+'</span>';*/}
function plzWait()	{/*document.getElementById('midi').innerHTML='<span class=wait>One moment please...</span>';*/}
function fName(s)	{/*document.getElementById('fname').innerHTML='<tt>'+s+'</tt>';*/}


function fromFile()
{
	plzWait()
	fName(document.getElementById('file').value)

	if (window.FileReader)
	{
		var reader = new FileReader()
		var f = document.getElementById('file').files[0]
		reader.onload = function(e)
			{readMidiFile(e.target.result)}
		reader.readAsBinaryString(f)
	}
	else
		err('File API is not supported in this browser!')
}
function fromUrl(){
 var url="http://people.eecs.ku.edu/~kroush/MidiToVex/Bach__Invention_No._13.mid"
 plzWait(); fName(url);
 try{
  var req=new XMLHttpRequest();
  req.open("GET",url,true);
  if(req.overrideMimeType){
   req.overrideMimeType("text/plain; charset=x-user-defined");
  }
  req.onreadystatechange=function(ev){
   if(req.readyState===4){
    if(req.status===200){
     var s='';
     if(typeof req.responseBody=='unknown'){ // MSIE
      var a=new VBArray(req.responseBody).toArray();
      for(var i=0;i<a.length;i++) s+=String.fromCharCode(a[i]);
     }
     else {
      var r=req.responseText;
      for(var i=0;i<r.length;i++) s+=String.fromCharCode(r.charCodeAt(i)&0xff);
     }
     readMidiFile(s);
    }
    else err(req.status+": "+req.statusText);
   }
  };
  req.send(null);
 }
 catch(e){ err(e);}
}
//fromUrl()
function fromString(){
 plzWait();
 fName('Base64 string');
 readMidiFile(JZZ.MidiFile.fromBase64(b64));
}
function fromPassedString(s){
 plzWait();
 fName('Base64 string');
 readMidiFile(JZZ.MidiFile.fromBase64(s));
}
function readMidiFile(s)
{
console.log(s)
	try
	{

		var mf = new JZZ.MidiFile(s)
		console.log(mf)
		var outMeasures = displayMidiFile(mf)

		console.log(outMeasures)
		drawSheets(outMeasures)
	}
	catch(e)
		{err(e)}
}

function displayMidiFile(mf)
{
	var ppqn = mf.ppqn
	var arg = []
	var notes = []
	var tempo = []
	var keysig = []
	var timesigs = []
	var measures = []
	var meas = {m: []}

	//populate arg[]
	for (var i = 0; i < mf.length; i++)
	{
		if (mf[i] instanceof JZZ.MidiFile.MTrk)
		{
			for (var j = 0; j < mf[i].length; j++)
			{
				var evt = mf[i][j]
				var s = evt.toString().replace(/&/g,'&amp;').replace(/>/g,'&gt;').replace(/</g,'&lt;')
				arg.push(evt.time + " " + s)
			}
		}
	}

	var item, thing
	var notes2 = []
	var singlemeasure = []
	console.log("arg")
	console.log(arg)
	//separate midi events by type
	var instruments={}

var lasttime=0;
var hitnote=false;
var title;
	for (item in arg)
	{
		var lts = arg[item].split(' ');
		if(lasttime>parseInt(lts[0])&&hitnote){
			instruments[title[4]]=notes;
			notes=[]
			console.log("here")

		}
		lasttime=parseInt(lts[0]);

		if(lts[1] / 10 == 9)	notes.push(lts)
		if(lts[1] / 10 == 8)	notes.push(lts)
		if(lts[1] == "ff51")	tempo.push(lts)
		if(lts[1] == "ff59")	keysig.push(lts)
		if(lts[1] == "ff58")	timesigs.push(lts)
		if(lts[1] == "ff03")	title=lts;
	}

			console.log("notes")
			console.log(notes)
	//populate notes2
	//go though and combine the note start and stops
	for (item = 0; item < notes.length; item++)
	{
		if (notes[item][6] == "On")
		{
			for (thing = item+1; thing < notes.length; thing++)
			{
				if (notes[item][2] == notes[thing][2])
				{
					notes2.push(
					{
						start:	notes[item][0],
						finish:	notes[thing][0],
						pitch:	notes[item][2],
						note:	((notes[thing][0]-notes[item][0])/ppqn)/4
					})
					break
				}
			}
		}
	}

	console.log("notes2")
	//console.log(notes2)
	var laststart = -1
	var lastfinish = 0
	var ppqmeas = ppqn*4
	var holder
	//populate measures
	for (noter in notes2)
	{
		if(keysig[0]&&lastfinish==keysig[0][0]){
				meas.key=keysig[0][4]
				keysig=keysig.slice(1)
		}
		if(timesigs[0]&&lastfinish==timesigs[0][0]){
			meas.time={top: timesigs[0][4].split('/')[0],
								 bottem: timesigs[0][4].split('/')[1]}
			timesigs=timesigs.slice(1)
		}

		if (lastfinish < notes2[noter].start)
		{
			//add rests here will need to loop
			while (lastfinish != notes2[noter].start)
			{
				if (ppqmeas < notes2[noter].start)
				{
					meas.m.push(
					{
						start:	lastfinish,
						finish:	ppqmeas,
						pitch:	-1,
						note:	((ppqmeas-lastfinish)/ppqn)/4
					})
					lastfinish = ppqmeas<notes2[noter].start ? ppqmeas : notes2[noter].start
						measures.push(meas)
						ppqmeas += ppqn*4
					meas = {m:[]}
				}
				else
				{
					meas.m.push(
					{
						start:	lastfinish,
						finish:	notes2[noter].start,
						pitch:	-1,
						note:	((notes2[noter].start-lastfinish)/ppqn)/4,

					})
					lastfinish = notes2[noter].start
				}
			}
		}

		if (notes2[noter].finish > ppqmeas)
		{
			//split note between measure will need to loop
			while (notes2[noter].finish > ppqmeas)
			{
				meas.m.push(
				{
					start:	notes2[noter].start,
					finish:	ppqmeas,
					pitch:	notes2[noter][2],
					note:	((ppqmeas-notes2[noter].start)/ppqn)/4,
					tie: true
				})
				notes2[noter].start = ppqmeas
				ppqmeas += ppqn*4
				measures.push(meas)
				meas = {m:[]}
			}
			lastfinish = notes2[noter].finish
		}
		else if (notes2[noter].finish == ppqmeas)
		{
			//add note and add meas
			meas.m.push(notes2[noter])
			measures.push(meas)
			ppqmeas += ppqn*4
			meas = {m:[]}
			lastfinish = notes2[noter].finish
		}
		else
		{
			//add note
			meas.m.push(notes2[noter])
			lastfinish = notes2[noter].finish
		}
	}
	return measures
}
</script>

<!-- Measures to VexFlow -->
<script>
function durToWhole(inFloat) //.125 > 8
{
	return 1 / inFloat
}

function pitToStr(inHex) //5C > G#6
{
	if (inHex == -1)
		return 'B/4' //rest position

	var note = Vex.Flow.integerToNote(parseInt(inHex, 16) % 12)
	var octave = parseInt(parseInt(inHex, 16) / 12)-1

	return note + '/' + octave
}

function drawSheets(inM)
{

	var timesig = {top: 4,
							   bottem: 4
								};
	var keysig={name: "C",
							acidentals:[]
						}


	for (var mC = 0; mC < inM.length; mC++)
	{
		var canvas = $("canvas")[0]
		//var canvas = $("canvas")[mC]
		var renderer = new Vex.Flow.Renderer(canvas, Vex.Flow.Renderer.Backends.CANVAS)
		var ctx = renderer.getContext()
		var stave = new Vex.Flow.Stave(STAFF_OFFSET_X, STAFF_OFFSET_Y * mC, CANVAS_WIDTH)

		// Add a treble clef
		stave.addClef("treble")
		if(inM[mC].time!=undefined){
			stave.addTimeSignature(""+timesig.top+'/'+timesig.bottem)
			timesig =inM[mC].time
		}
		if(inM[mC].key!=undefined){
			keysig.name =inM[mC].key
			keysig.Accidental=[]

			//stave.addKeySignature(keysig.name)
		}
		stave.addKeySignature(keysig.name)
		stave.setContext(ctx).draw()

		//create notes from inM
		var notes = []


		console.log('measure ' + mC)
		var forbeamnotes=[],
		    allbeams=[],
				lengthofbeam=0;
		for (var n = 0, i=0; n < inM[mC].m.length; n++)
		{
			var pit = pitToStr(inM[mC].m[n].pitch)
			var dur = durToWhole(inM[mC].m[n].note) + (inM[mC].m[n].pitch == -1 ? 'r' : '') //append 'r' if this note is a rest
			console.log('note' + n + ': ' + dur + ', ' + pit)


			notes.push(new Vex.Flow.StaveNote({ keys: [pit], duration: dur }))
			if(!keysig.acidentals.includes(pit)&&pit.includes('#')){
				notes[notes.length-1].  addAccidental(0, new Vex.Flow.Accidental("#"))
			}
			if(i<4&&inM[mC].m[n].note<.25){
				forbeamnotes.push(notes[notes.length-1])
				i++;
				lengthofbeam+=inM[mC].m[n].note;
			}else if((1/(lengthofbeam/.50))%2==0){

				allbeams.push(new Vex.Flow.Beam(forbeamnotes))
				console.log(forbeamnotes)
				forbeamnotes=[];
				lengthofbeam=0;
				i=0;
			}else{
				forbeamnotes=[];
				lengthofbeam=0;
				i=0;
			}
			if(i==4||(lengthofbeam==.5&&i>1)||((1/(lengthofbeam/.50))%2==0&&n == inM[mC].m.length-1)){
				console.log(forbeamnotes)
				allbeams.push(new Vex.Flow.Beam(forbeamnotes))
				forbeamnotes=[];
				lengthofbeam=0;
				i=0;
			}
		}
		console.log('')

		// Create a voice in 4/4
		function create_voice(sig)
		{
			return new Vex.Flow.Voice(
			{
				num_beats:	sig.top,
				beat_value:	sig.bottem,
				resolution:	Vex.Flow.RESOLUTION
			})
		}

		// Create voices and add notes to each of them
		var voice = create_voice(timesig).addTickables(notes)

		// Format and justify the notes
		var formatter = new Vex.Flow.Formatter().joinVoices([voice]).format([voice], CANVAS_WIDTH)

		// Render voice
		voice.draw(ctx, stave)
		while(allbeams.length){
			allbeams.pop().setContext(ctx).draw();
		}
	}
///	console.log("Successful run!")
}
//loader()
	function loader(){
		songname=document.location.search.split("=")[1]
		console.log(songname);

		  $.get('http://people.eecs.ku.edu/~sbenson/grabMidi.php',{
		          title: songname
							//url: 'http://people.eecs.ku.edu/~sbenson/grabMidi.php'
		        },
		    function(data, status){
					console.log(status)
					console.log(data)
					fromPassedString(data)
		  });

	}



</script>
</body>
</html>
